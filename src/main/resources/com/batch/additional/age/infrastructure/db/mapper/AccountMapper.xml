<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.batch.additional.age.infrastructure.db.mapper.AccountMapper">

    <!-- 全データ取得 -->
    <select id="findAll" resultType="com.batch.additional.age.infrastructure.db.dto.DbAccountInfo">
        SELECT
            ACCOUNT_ID  AS accountId,
            LAST_NAME   AS lastName,
            FIRST_NAME  AS firstName,
            AGE         AS age,
            BIRTH_DAY   AS birthDay,
            CREATED_AT  AS createdAt,
            CREATE_USER AS createUser,
            UPDATE_AT   AS updateAt,
            UPDATE_USER AS updateUser,
            DELETE_FLG  AS deleteFlg
        FROM
            ACCOUNT
        WHERE
            DELETE_FLG = '0'
    </select>

    <!-- 今日が誕生日のユーザ一覧を取得 -->
    <select id="fetchTodayBirthAccount" resultType="com.batch.additional.age.infrastructure.db.dto.DbAccountInfo">
        SELECT
            ACCOUNT_ID  AS accountId,
            LAST_NAME   AS lastName,
            FIRST_NAME  AS firstName,
            AGE         AS age,
            BIRTH_DAY   AS birthDay,
            CREATED_AT  AS createdAt,
            CREATE_USER AS createUser,
            UPDATE_AT   AS updateAt,
            UPDATE_USER AS updateUser,
            DELETE_FLG  AS deleteFlg
        FROM
            ACCOUNT
        WHERE
            #{today} = TO_CHAR(BIRTH_DAY,'MMDD')
          AND
            DELETE_FLG = '0'
    </select>

    <!-- 年齢を更新 -->
    <update id="updateAccountAge" timeout="3">
        UPDATE
            ACCOUNT
        SET
            AGE = #{age},
            UPDATE_AT = CURRENT_DATE,
            UPDATE_USER = '年齢更新バッチ'
        WHERE
            ACCOUNT_ID = #{accountId}
          AND
            DELETE_FLG = '0'
    </update>

</mapper>